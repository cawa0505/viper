#! /bin/bash

# this script is more towards when the network settings is bridge,
# however I think it works in other settings as well.

# default user and password to the vm
vmuser="mhewedy"

# --- start of util functions

# $1 is the vm name
getvmip() {
  vmname=$1
  vmip "$vmname" # see vmip subdirectory
  while [ $? -ne 0 ]; do
    sleep 5
    vmip "$vmname"
  done
}

# -- start of case functions
create_fn() {
  next=$(($(vboxmanage list vms | sort | tail -n 1 | cut -d " " -f1 | cut -d "\"" -f2 | cut -d "_" -f2) + 1))
  vmname="vm_$(printf %02d $next)"
  vmbasedir="$HOME/.vms"
  mkdir -p "$vmbasedir"
  vboxmanage import "$2" --vsys 0 --vmname "$vmname" --basefolder "$vmbasedir" --cpus 1 --memory 1024
}

rm_fn() {
  # accept multiple vms names
  for vmname in "${@:2}"; do
    echo "deleting $vmname ..."
    vboxmanage controlvm "$vmname" poweroff
    VBoxManage unregistervm "$vmname" --delete
  done
}

start_fn() {
  # accept multiple vms names
  for vmname in "${@:2}"; do
    echo "starting $vmname ..."
    vboxmanage startvm "$vmname" --type headless
  done
}

stop_fn() {
  # accept multiple vms names
  for vmname in "${@:2}"; do
    echo "stoping $vmname ..."
    vboxmanage controlvm "$vmname" poweroff
  done
}

# ---- start of case statement
case $1 in
ls) # vm ls
  vboxmanage list vms | cut -d " " -f1 | cut -d "\"" -f2
  ;;
ps) # vm ps
  vboxmanage list runningvms | cut -d " " -f1 | cut -d "\"" -f2
  ;;
create)
  create_fn "$@"
  ;;
rm)
  if [ $# -eq 1 ]; then
    printf "Usage:\n\tvm rm <vmname1>,[vmname2],...\n\n"
    exit 2
  fi

  rm_fn "$@"
  ;;
start)
  if [ $# -eq 1 ]; then
    printf "Usage:\n\tvm start <vmname1>,[vmname2],...\n\n"
    exit 2
  fi

  start_fn "$@"
  ;;
stop)
  if [ $# -eq 1 ]; then
    printf "Usage:\n\tvm stop <vmname1>,[vmname2],...\n\n"
    exit 2
  fi

  stop_fn "$@"
  ;;
ssh)
  if [ $# -lt 1 ]; then
    printf "Usage:\n\tvm ssh <vmname>\n\n"
    exit 2
  fi
  ip=$(getvmip "$2")
  ssh "$vmuser@$ip" "${@:3}"
  ;;
*)
  printf "Usage:\n\tvm (ls | ps | create | rm | start | stop | ssh) [options]\n\n"
  exit 2
  ;;
esac
