#! /bin/sh

# --- start of util functions

# $1 is the vm name
getvmip() {
  vmname=$1
  vmip "$vmname" # see vmip subdirectory
  while [ $? -ne 0 ]; do
    sleep 5
    vmip "$vmname"
  done
}

# -- start of case functions
new_fn() {
  next=$(($(vboxmanage list vms | sort | tail -n 1 | cut -d " " -f1 | cut -d "\"" -f2 | cut -d "_" -f2) + 1))
  vmname="vm_$(printf %02d $next)"
  vboxmanage import "$2" --vsys 0 --vmname "$vmname"

  # custom script
  if [[ $? -eq 0 && $# -eq 3 ]]; then
    echo "provisioning"
    # FIXME: work on provistioners
    #consider change the PS1 env var to include the ip addr:
    #export PS1="\[\e[1;35m\]\u\[\033[m\]@\h-\[\e[1;92m\]\$(hostname -I | awk '{print \$1}')\[\033[m\]:\w \$ "
  fi
}

rm_fn() {
  # accept multiple vms names
  for vmname in "${@:2}"; do
    echo "deleting $vmname ..."
    vboxmanage controlvm "$vmname" poweroff
    VBoxManage unregistervm "$vmname" --delete
  done
}

start_fn() {
  # accept multiple vms names
  for vmname in "${@:2}"; do
    echo "starting $vmname ..."
    vboxmanage startvm "$vmname" --type headless
  done
}

stop_fn() {
  # accept multiple vms names
  for vmname in "${@:2}"; do
    echo "stoping $vmname ..."
    vboxmanage controlvm "$vmname" poweroff
  done
}

# ---- start of case statement
case $1 in
ls) # vm ls
  vboxmanage list vms | cut -d " " -f1 | cut -d "\"" -f2
  ;;
ps) # vm ps
  vboxmanage list runningvms | cut -d " " -f1 | cut -d "\"" -f2
  ;;
new)
  new_fn "$@"
  ;;
rm)
  if [ $# -eq 1 ]; then
    echo "usage: vm rm <vmname>..."
    exit 2
  fi

  rm_fn "$@"
  ;;
start)
  if [ $# -eq 1 ]; then
    echo "usage: vm start <vmname>..."
    exit 2
  fi

  start_fn "$@"
  ;;
stop)
  if [ $# -eq 1 ]; then
    echo "usage: vm stop <vmname>..."
    exit 2
  fi

  stop_fn "$@"
  ;;
ssh)
  if [ $# -eq 1 ]; then
    echo "usage: vm stop <vmname>"
    exit 2
  fi
  ip=$(getvmip "$2")
  ssh mhewedy@"$ip"
  ;;
pack) # WIP
  if [ $# -eq 1 ]; then
    echo "usage: vm pack <vmname>"
    exit 2
  fi
  #vboxmanage controlvm "$2" poweroff
  vboxmanage export "$2" -o vm.ova --ovf10 --manifest --options nomacs --vsys 0 --vmname vm
  #vboxmanage startvm "$2" --type headless
  ;;
*)
  echo "usage: vm (ls|ps|new|rm|start|stop|ssh|pack) [options]"
  exit 2
  ;;
esac
