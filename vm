#! /bin/sh

# this script is more towards when the network settings is bridge,
# however I think it works in other settings as well.

# default user and password to the vm
vmuser="mhewedy"
vmpassword="password"

# --- start of util functions

# $1 is the vm name
getvmip() {
  vmname=$1
  vmip "$vmname" # see vmip subdirectory
  while [ $? -ne 0 ]; do
    sleep 5
    vmip "$vmname"
  done
}

# -- start of case functions
create_fn() {
  next=$(($(vboxmanage list vms | sort | tail -n 1 | cut -d " " -f1 | cut -d "\"" -f2 | cut -d "_" -f2) + 1))
  vmname="vm_$(printf %02d $next)"
  vboxmanage import "$2" --vsys 0 --vmname "$vmname"
  #  vmname="vm_01"
  #
  #  if [ "$#" -gt 2 ]; then
  #    script=$3
  #    echo "executing script $script"
  #    ip=$(getvmip "$vmname")
  #    ssh -t "$vmuser@$ip" "sudo mkdir /testme"# < "$script"
  #  fi
}

rm_fn() {
  # accept multiple vms names
  for vmname in "${@:2}"; do
    echo "deleting $vmname ..."
    vboxmanage controlvm "$vmname" poweroff
    VBoxManage unregistervm "$vmname" --delete
  done
}

start_fn() {
  # accept multiple vms names
  for vmname in "${@:2}"; do
    echo "starting $vmname ..."
    vboxmanage startvm "$vmname" --type headless
  done
}

stop_fn() {
  # accept multiple vms names
  for vmname in "${@:2}"; do
    echo "stoping $vmname ..."
    vboxmanage controlvm "$vmname" poweroff
  done
}

# ---- start of case statement
case $1 in
ls) # vm ls
  vboxmanage list vms | cut -d " " -f1 | cut -d "\"" -f2
  ;;
ps) # vm ps
  vboxmanage list runningvms | cut -d " " -f1 | cut -d "\"" -f2
  ;;
create)
  create_fn "$@"
  ;;
rm)
  if [ $# -eq 1 ]; then
    echo "usage: vm rm <vmname>..."
    exit 2
  fi

  rm_fn "$@"
  ;;
start)
  if [ $# -eq 1 ]; then
    echo "usage: vm start <vmname>..."
    exit 2
  fi

  start_fn "$@"
  ;;
stop)
  if [ $# -eq 1 ]; then
    echo "usage: vm stop <vmname>..."
    exit 2
  fi

  stop_fn "$@"
  ;;
ssh)
  if [ $# -eq 1 ]; then
    echo "usage: vm stop <vmname>"
    exit 2
  fi
  ip=$(getvmip "$2")
  ssh "$vmuser@$ip"
  ;;
*)
  echo "usage: vm (ls|ps|create|rm|start|stop|ssh) [options]"
  exit 2
  ;;
esac
