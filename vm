#! /bin/sh

# WIP
# $1 is the vm name
initmachine() {
  vmname=$1
  echo "initializing the machine... $vmname"
  ip=$(getvmip "$vmname")
  echo "ip=$ip"

  ssh mhewedy@"$ip" <<'ENDSSH'
touch x
echo "PS1=\"\[\e[1;35m\]\u\[\033[m\]@\h-\[\e[1;92m\]$(hostname -I | awk '{print $1}')\[\033[m\]:\w \$ \"" >>.bashrc
ENDSSH
}

# $1 is the vm name
getvmip() {
  vmname=$1
  vmip "$vmname" # see vmip subdirectory
  while [ $? -ne 0 ]; do
    sleep 5
    vmip "$vmname"
  done
}

case $1 in
list)
  vboxmanage list vms
  ;;
ps)
  vboxmanage list runningvms
  ;;
create)
  next=$(($(vboxmanage list vms | sort | tail -n 1 | cut -d " " -f1 | cut -d "\"" -f2 | cut -d "-" -f2) + 1))
  vmname="vm-$(printf %02d $next)"
  vboxmanage import "$2" --vsys 0 --vmname "$vmname"
  ;;
delete)
  vboxmanage controlvm "$2" poweroff
  VBoxManage unregistervm "$2" --delete
  ;;
start)
  vboxmanage startvm "$2" --type headless
  if [ $? -eq 0 ]; then
    echo "getting ip address..."
    ip=$(getvmip "$2")
    echo "\033[1;32m$ip\033[0m"
  fi
  ;;
stop)
  vboxmanage controlvm $2 poweroff
  ;;
*)
  echo "usage vm (list|ps|create|delete|start|stop) [options]"
  ;;
esac
